from knowledge_base import KnowledgeBase, Rule

def build_knowledge_base() -> KnowledgeBase:
    rules: list[Rule] = []

    # 1. Перегретый рынок
    rules.append(
        Rule(
            name="overheated_seller_market",
            description="Признаки перегретого рынка / рынка продавца",
            condition=lambda f: (
                f["price_trend"] == "strong_growth"
                and f["liquidity"] == "fast"
                and f["mortgage_rate"] in ("low", "medium")
            ),
            recommendation=(
                "Рынок демонстрирует признаки перегретого рынка продавца:\n"
                "- Цены сильно растут.\n"
                "- Объекты продаются быстро.\n"
                "- Ставки по ипотеке низкие или средние.\n\n"
                "Рекомендация:\n"
                "- Покупка несёт повышенный риск переплаты за актив.\n"
                "- Для спекуляций и краткосрочных стратегий риск особенно высок.\n"
                "- Имеет смысл тщательно взвесить решение и рассмотреть сценарий коррекции цен."
            ),
        )
    )

    # 2. Рынок покупателя
    rules.append(
        Rule(
            name="buyer_market",
            description="Признаки рынка покупателя",
            condition=lambda f: (
                f["price_trend"] in ("stable", "decline")
                and f["liquidity"] == "slow"
            ),
            recommendation=(
                "Наблюдаются признаки рынка покупателя:\n"
                "- Цены стабильны или снижаются.\n"
                "- Объекты продаются долго.\n\n"
                "Рекомендация:\n"
                "- У покупателя выше переговорная сила, можно рассчитывать на скидки.\n"
                "- Покупка может быть выгодной при аккуратном выборе объекта.\n"
                "- Для инвестора важно учесть доходность аренды и возможное дальнейшее снижение цен."
            ),
        )
    )

    # 3. Интерес рынка для инвестиций под аренду
    rules.append(
        Rule(
            name="rental_investment_attractive",
            description="Высокая доходность аренды при стабильных или растущих ценах",
            condition=lambda f: (
                f["rental_yield"] == "high"
                and f["price_trend"] in ("moderate_growth", "stable")
                and f["goal"] == "investment"
            ),
            recommendation=(
                "Рынок выглядит привлекательным для инвестиций под аренду:\n"
                "- Доходность аренды высокая.\n"
                "- Цены стабильны или умеренно растут.\n\n"
                "Рекомендация:\n"
                "- Имеет смысл рассмотреть покупку объектов для сдачи в аренду.\n"
                "- Важно дополнительно оценить риски простоя и качество локации."
            ),
        )
    )

    # 4. Спекуляция на уже разогретом рынке
    rules.append(
        Rule(
            name="speculation_high_risk",
            description="Спекуляция при уже сильном росте цен",
            condition=lambda f: (
                f["goal"] == "speculation"
                and f["price_trend"] == "strong_growth"
            ),
            recommendation=(
                "Цель — краткосрочная спекуляция при уже сильном росте цен.\n"
                "Рынок может находиться в поздней фазе цикла.\n\n"
                "Рекомендация:\n"
                "- Спекулятивные операции несут повышенный риск.\n"
                "- Возможна коррекция цен, стоит крайне осторожно подходить к таким стратегиям."
            ),
        )
    )

    # 5. Покупка для собственного проживания при долгом горизонте планирования
    rules.append(
        Rule(
            name="own_use_long_horizon",
            description="Покупка для собственных нужд при длинном горизонте",
            condition=lambda f: (
                f["goal"] == "own_use"
                and f["horizon"] == "long"
                and f["mortgage_rate"] != "high"
            ),
            recommendation=(
                "Цель — собственное жильё, горизонт владения долгий, ставки не максимальные.\n\n"
                "Рекомендация:\n"
                "- Даже при неидеальной рыночной конъюнктуре покупка может быть оправданной,\n"
                "  так как жильё носит потребительский характер.\n"
                "- Важно не брать чрезмерную долговую нагрузку."
            ),
        )
    )

    # 6. Высокие ставки по ипотеке -> осторожность с покупкой
    rules.append(
        Rule(
            name="high_mortgage_caution",
            description="Высокие ставки по ипотеке",
            condition=lambda f: f["mortgage_rate"] == "high",
            recommendation=(
                "Ставки по ипотеке высокие.\n\n"
                "Рекомендация:\n"
                "- Покупка с ипотекой может быть финансово тяжёлой.\n"
                "- Имеет смысл рассмотреть аренду, накопление или ожидание более благоприятных условий."
            ),
        )
    )

    # 7. Низкая готовность к риску -> консервативные стратегии
    rules.append(
        Rule(
            name="low_risk_profile",
            description="Низкий риск-профиль пользователя",
            condition=lambda f: f["risk_profile"] == "low",
            recommendation=(
                "Пользователь имеет низкую готовность к риску.\n\n"
                "Рекомендация:\n"
                "- Избегать агрессивных спекулятивных операций.\n"
                "- Делать упор на устойчивые объекты в хороших локациях\n"
                "  и умеренный уровень долговой нагрузки."
            ),
        )
    )

    # 8. Краткий горизонт и цель — собственное жильё -> осторожность
    rules.append(
        Rule(
            name="short_horizon_own_use",
            description="Короткий горизонт владения собственным жильём",
            condition=lambda f: (
                f["goal"] == "own_use"
                and f["horizon"] == "short"
            ),
            recommendation=(
                "Горизонт владения жильём короткий (до 3 лет), при этом цель — собственное проживание.\n\n"
                "Рекомендация:\n"
                "- Покупка может быть невыгодной из-за высоких транзакционных издержек и рисков\n"
                "  изменения рыночной конъюнктуры.\n"
                "- Имеет смысл рассмотреть аренду на этот период."
            ),
        )
    )

    return KnowledgeBase(rules)
